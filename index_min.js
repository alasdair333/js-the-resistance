function Player(e,t){this.name=e,this.socket=t}function Room(e,t,a,s,o){this.name=e,this.password=t,this.owner=a,this.players=s,this.game=o,this.state=o.stateName}Array.prototype.shuffle=function(){var e,t,a=this.length;if(0==a)return this;for(;--a;)e=Math.floor(Math.random()*(a+1)),t=this[a],this[a]=this[e],this[e]=t;return this};var Resistance=function(){this.state=0,this.players=null,this.characters=[],this.teamLeader=-1;var e={name:"init",func:function(e){for(var t=0,a=0;a<e.players.length;a++)e.players[a].socket.emit("chat message","TheGame","Lets play a game: "+e.players[a].name);switch(e.players.length){case 5:case 6:t=2;break;case 7:case 8:case 9:t=3;break;case 10:t=4}for(var a=0;a<e.players.length;a++)t>0?(e.characters.push("Spy"),t--):e.characters.push("Resistance");e.characters.shuffle(),e.state++}},t={name:"dealCharacters",func:function(e){for(var t=0;t<e.players.length;t++)e.players[t].side=e.characters[t],e.players[t].socket.emit("chat message","TheGame","You are: "+e.players[t].side);e.state++}},a={name:"revelSpies",func:function(e){var t=[],a=0;for(a=0;a<e.players.length;a++)"Spy"==e.players[a].side&&t.push(e.players[a]);var s="Spies: ";for(a=0;a<t.length;a++)s+=t[a].name+" ";for(a=0;a<t.length;a++)t[a].socket.emit("chat message","TheGame",s);e.state++}},s={name:"teamLeader",func:function(e){-1==e.teamLeader?e.teamLeader=Math.floor(Math.random()*e.players.length):(e.teamLeader++,e.teamLeader>=e.players.length&&(e.teamLeader=0)),e.players[e.teamLeader].socket.emit("chat message","TheGame","You are the leader, choose your team"),e.state++}},o={name:"teamBuild",func:function(e){e.state++}},n={name:"voteTeam",func:function(){}},r={name:"mission",func:function(){}},i={name:"missionEnd",func:function(){}},m={name:"endGame",func:function(){}};this.ResistanceGameState=[e,t,a,s,o,n,r,i,m],this.stateName=this.ResistanceGameState[this.state].name,this.processEvent=function(t){switch(t.event){case"start game":e.func(this);break;case"next state":this.ResistanceGameState[this.state].func(this);break;default:console.log("Error")}}},app=require("express")(),http=require("http").Server(app),io=require("socket.io")(http),rooms=[];app.get("/",function(e,t){for(var a="Please connect to a chatroom: \n",s=0;s<rooms.length;s++)a+="Room: "+rooms[s].name+" Current state: "+rooms[s].state+"\n";t.send(a)}),app.get("/:room",function(e,t){t.sendfile("Client/index.html")}),io.on("connection",function(e){e.on("join room",function(t,a,s){for(var o=!1,n=!1,r=null,i=new Player(t,e),m=0;m<rooms.length;m++)if(rooms[m].name==a){o=!0,r=rooms[m];break}if(o)r.password==s?(r.players.push(i),n=!0):e.emit("join failed","Password incorrect");else{var c=new Resistance,h=new Room(a,s,e,[],c);c.players=h.players,h.players.push(i),rooms.push(h),r=h,n=!0}n?(e.username=t,e.room=a,e.join(a),e.emit("updateroom","You have connected to "+a,t),e.broadcast.to(e.room).emit("updateroom",t+" has connected to room",t)):e.emit("join failed","Failed to join room")}),e.on("leave room",function(){e.leave(e.room)}),e.on("chat message",function(t){io.to(e.room).emit("chat message",e.username,t)}),e.on("game event",function(e,t){for(var a=0;a<rooms.length;a++)rooms[a].name==e&&rooms[a].game.processEvent(t)})}),http.listen(3e3,function(){console.log("listening on *:3000")});